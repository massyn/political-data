{% extends "base.jinja" %}

{% block title %}{{ indicator.indicator.title }} - {{ jurisdiction }} - Political Data Dashboard{% endblock %}

{% block content %}
<div class="my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ jurisdiction.lower() }}.html">{{ jurisdiction }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ indicator.indicator.title }}</li>
        </ol>
    </nav>

    <h1 class="mb-4">{{ indicator.indicator.title }}</h1>

    <div class="content-card mb-4">
        <h2>Metadata</h2>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Category:</strong> {{ indicator.indicator.category }}</p>
                <p><strong>Frequency:</strong> {{ indicator.indicator.frequency }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Source:</strong> <a href="{{ indicator.indicator.source }}" target="_blank" rel="noopener noreferrer">{{ indicator.indicator.source }}</a></p>
            </div>
        </div>
        {% if indicator.indicator.description %}
        <div class="mt-3">
            <p><strong>Description:</strong></p>
            <p>{{ indicator.indicator.description }}</p>
        </div>
        {% endif %}
    </div>

    {% if indicator.indicator.graph and indicator.indicator.graph is not sameas false %}
    {% for graph_config in indicator.indicator.graph %}
    <div class="content-card mb-4">
        <h2>{{ graph_config.title }}</h2>
        {% if indicator.data and indicator.data|length > 0 %}
        <canvas id="chart-{{ loop.index }}" style="max-height: 400px;"></canvas>
        {% else %}
        <p class="text-muted">No data available</p>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    <div class="content-card">
        <h2>{% if indicator.indicator.graph and indicator.indicator.graph is not sameas false %}Data Table{% else %}Historical Data{% endif %}</h2>
        {% if indicator.data and indicator.data|length > 0 %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        {% for key in indicator.data[0].keys() %}
                        <th>{{ key|title }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in indicator.data|reverse %}
                    <tr>
                        {% for key, value in row.items() %}
                        <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted mt-3">Showing {{ indicator.data|length }} record(s)</p>
        {% else %}
        <p class="text-muted">No data available</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if indicator.indicator.graph and indicator.indicator.graph is not sameas false %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
{% for graph_config in indicator.indicator.graph %}
(function() {
    const ctx = document.getElementById('chart-{{ loop.index }}');

    // Prepare data from indicator
    const data = {{ indicator.data|tojson }};

    // Extract x and y values
    const labels = data.map(row => row['{{ graph_config.x }}']);
    const values = data.map(row => parseFloat(row['{{ graph_config.y }}']));

    {% if graph_config.get('overlay_metric') and overlay_data.get(graph_config.overlay_metric) %}
    // Prepare overlay metric data
    const overlayDataRaw = {{ overlay_data[graph_config.overlay_metric]['data']|tojson }};

    // Get the data range
    const firstDataDate = labels[0];
    const lastDataDate = labels[labels.length - 1];

    // Filter overlay data to only include entries within or overlapping the data range
    const overlayData = overlayDataRaw.filter((entry, index) => {
        const entryDate = entry.date;
        const nextDate = index < overlayDataRaw.length - 1 ? overlayDataRaw[index + 1].date : null;

        // Include if the entry starts before data ends and (is the last entry or next entry starts after data begins)
        return entryDate <= lastDataDate && (!nextDate || nextDate >= firstDataDate);
    });

    // Create annotations for government changes
    const annotations = {};

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Add background boxes for each government period
    for (let i = 0; i < overlayData.length; i++) {
        // Start at the later of: government start date or first data date
        const govStartDate = overlayData[i].date;
        const startDate = govStartDate > firstDataDate ? govStartDate : firstDataDate;

        // End at the earlier of: next government start date or last data date
        let endDate;
        if (i < overlayData.length - 1) {
            const nextGovDate = overlayData[i + 1].date;
            endDate = nextGovDate < lastDataDate ? nextGovDate : lastDataDate;
        } else {
            endDate = lastDataDate;
        }

        const colour = overlayData[i].colour || '#cccccc';
        const rgbaColor = hexToRgba(colour, 0.15);

        annotations[`box${i}`] = {
            type: 'box',
            xMin: startDate,
            xMax: endDate,
            backgroundColor: rgbaColor,
            borderWidth: 0,
            z: -1
        };
    }

    // Add vertical lines at government change dates (only if within data range)
    for (let i = 0; i < overlayData.length; i++) {
        const changeDate = overlayData[i].date;

        // Only draw the line if it's within the data range (not at the start)
        if (changeDate > firstDataDate && changeDate <= lastDataDate) {
            annotations[`line${i}`] = {
                type: 'line',
                xMin: changeDate,
                xMax: changeDate,
                borderColor: 'rgba(0, 0, 0, 0.5)',
                borderWidth: 1,
                borderDash: [5, 5],
                z: 0
            };
        }
    }
    {% endif %}

    // Prepare data in x/y format for time scale
    const chartData = labels.map((label, index) => ({
        x: label,
        y: values[index]
    }));

    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: '{{ graph_config.title }}',
                data: chartData,
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                }
                {% if graph_config.get('overlay_metric') and overlay_data.get(graph_config.overlay_metric) %}
                ,
                annotation: {
                    annotations: annotations
                }
                {% endif %}
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'month',
                        displayFormats: {
                            month: 'MMM yyyy'
                        }
                    },
                    title: {
                        display: true,
                        text: '{{ graph_config.x|title }}'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '{{ graph_config.y|title }}'
                    }
                }
            }
        }
    });
})();
{% endfor %}
</script>
{% endif %}
{% endblock %}
